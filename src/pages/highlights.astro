---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
---

<BaseLayout title="My Highlights â€” Paul Graham Essays">
  <Header currentPage="highlights" />

  <main class="max-w-3xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold tracking-tight mb-2" style="color: var(--theme-text);">
          My Highlights
        </h1>
        <p id="highlight-count" class="text-sm" style="color: var(--theme-text-secondary);"></p>
      </div>
      <div class="flex gap-2">
        <button id="export-text" class="px-3 py-1.5 text-sm rounded-lg border"
                style="border-color: var(--theme-border); color: var(--theme-text);">
          Export Text
        </button>
        <button id="export-json" class="px-3 py-1.5 text-sm rounded-lg border"
                style="border-color: var(--theme-border); color: var(--theme-text);">
          Export JSON
        </button>
      </div>
    </div>

    <div id="highlights-container"></div>
    <p id="no-highlights" class="hidden text-center py-12"
       style="color: var(--theme-text-secondary);">
      No highlights yet. Select text in any essay to create a highlight.
    </p>
  </main>

  <script>
    import { initSettings } from "../scripts/reader-settings";
    import { getAllAnnotations, exportAnnotations } from "../scripts/annotations";
    initSettings();

    const container = document.getElementById("highlights-container")!;
    const countEl = document.getElementById("highlight-count")!;
    const noHighlights = document.getElementById("no-highlights")!;
    const store = getAllAnnotations();
    const base = import.meta.env.BASE_URL;

    const entries = Object.entries(store).filter(([, a]) => a.length > 0);
    const totalCount = entries.reduce((sum, [, a]) => sum + a.length, 0);

    if (entries.length === 0) {
      noHighlights.classList.remove("hidden");
      countEl.textContent = "0 highlights";
    } else {
      countEl.textContent = `${totalCount} highlights across ${entries.length} essays`;

      for (const [slug, annotations] of entries) {
        const section = document.createElement("div");
        section.className = "mb-8";
        section.innerHTML = `
          <h2 class="text-lg font-semibold mb-3">
            <a href="${base}read/${slug}" class="hover:underline" style="color: var(--theme-text);">
              ${slug.replace(/-/g, " ")}
            </a>
          </h2>
          <div class="space-y-3">
            ${annotations.map((a) => `
              <blockquote class="pl-4 py-2 rounded-r-lg text-sm" style="border-left: 3px solid; border-color: ${
                a.color === "yellow" ? "#facc15" :
                a.color === "green" ? "#4ade80" :
                a.color === "blue" ? "#60a5fa" : "#f472b6"
              }; color: var(--theme-text);">
                ${a.text}
                <div class="mt-1 text-xs" style="color: var(--theme-text-secondary);">
                  ${new Date(a.createdAt).toLocaleDateString()}
                </div>
              </blockquote>
            `).join("")}
          </div>
        `;
        container.appendChild(section);
      }
    }

    // Export
    function download(content: string, filename: string) {
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    document.getElementById("export-text")?.addEventListener("click", () => {
      download(exportAnnotations("text"), "pg-highlights.txt");
    });
    document.getElementById("export-json")?.addEventListener("click", () => {
      download(exportAnnotations("json"), "pg-highlights.json");
    });
  </script>
</BaseLayout>
