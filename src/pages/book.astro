---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import { getCollection } from "astro:content";

const essays = (await getCollection("essays"))
  .sort((a, b) => a.data.dateISO.localeCompare(b.data.dateISO));

// Group by year
const byYear = new Map<string, typeof essays>();
for (const essay of essays) {
  const year = essay.data.dateISO.slice(0, 4) || "Unknown";
  if (!byYear.has(year)) byYear.set(year, []);
  byYear.get(year)!.push(essay);
}
const base = import.meta.env.BASE_URL;
---

<BaseLayout title="Book Mode — Paul Graham Essays">
  <Header currentPage="book" />

  <main class="max-w-3xl mx-auto px-4 py-12">
    <header class="mb-12">
      <h1 class="text-3xl font-bold tracking-tight mb-2" style="color: var(--theme-text);">
        Read in Order
      </h1>
      <p class="text-sm" style="color: var(--theme-text-secondary);">
        {essays.length} essays, chronologically from Paul Graham's earliest to latest.
      </p>
    </header>

    {[...byYear.entries()].map(([year, yearEssays]) => (
      <section class="mb-10">
        <h2 class="text-lg font-semibold mb-4 sticky top-14 py-2 z-10"
            style="color: var(--theme-text); background-color: var(--theme-bg);">
          {year}
        </h2>
        <ol class="space-y-1">
          {yearEssays.map((essay) => (
            <li>
              <a href={`${base}read/${essay.data.slug}`}
                 class="flex items-baseline gap-3 py-2 group"
                 data-essay-slug={essay.data.slug}>
                <span class="text-xs tabular-nums shrink-0"
                      style="color: var(--theme-text-secondary);">
                  {essays.indexOf(essay) + 1}.
                </span>
                <span class="group-hover:opacity-70 transition-opacity"
                      style="color: var(--theme-text);">
                  <span class="read-check hidden mr-1 text-green-500">✓</span>
                  {essay.data.title}
                </span>
                <span class="text-xs shrink-0"
                      style="color: var(--theme-text-secondary);">
                  {essay.data.readingTime}m
                </span>
              </a>
            </li>
          ))}
        </ol>
      </section>
    ))}
  </main>

  <script>
    import { initSettings } from "../scripts/reader-settings";
    import { initReadIndicators } from "../scripts/reading-history";
    initSettings();
    initReadIndicators();
  </script>
</BaseLayout>
